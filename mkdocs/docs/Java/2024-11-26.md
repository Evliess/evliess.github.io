---
layout: index
title: "Spring Security"
category: java
date: 2024-11-26 09:03:55
---

# Springboot custom authentication provider to verify bearer token

## Environment

- Springbootï¼š3.3.1 
- SpringSecurity: 6.3.1
- JDK 17+

## 1. Custom a authentication token
```java
public class CustomBearerToken extends AbstractAuthenticationToken {
    private String principal;

    // this is an authenticated token
    public CustomBearerToken(String principal, Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.principal = principal;
        setAuthenticated(true);
    }
    // this is not an authenticated token
    public CustomBearerToken(String principal) {
        super(null);
        this.principal = principal;
        setAuthenticated(false);
    }

    @Override
    public Object getCredentials() {
        return null;
    }

    @Override
    public Object getPrincipal() {
        return this.principal;
    }
}
```
## 2. Custom an authentication provider, it will be used to verify a authentication

```java
@Component
public class CustomAuthenticationProvider implements AuthenticationProvider {
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        //custom logic to verify this authentication
        if (authentication != null) {
            String principal = authentication.getPrincipal().toString();
            if ("admin".equals(principal)) {
                List<SimpleGrantedAuthority> roles = List.of();
                // return a valid token
                return new CustomBearerToken("admin", roles);
            } else {
                return authentication;
            }
        }
        return null;
    }


    // which type of authentication will be verified
    @Override
    public boolean supports(Class<?> authentication) {
        return authentication.equals(CustomBearerToken.class);
    }
}
```

## 3. Create a new filter on intercept all the requests
```java
public class CustomWebFilter extends OncePerRequestFilter {
    private final AuthenticationManager authenticationManager;

    public CustomWebFilter(AuthenticationManager authenticationManager) {
        this.authenticationManager = authenticationManager;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        String token = request.getHeader("Authentication");
        if (token != null) {
            String encodedToken = new String(Base64.getUrlDecoder().decode(token.getBytes(StandardCharsets.UTF_8)));
            Authentication authentication = new CustomBearerToken(encodedToken.split(":")[0]);
            Authentication verifiedAuth = this.authenticationManager.authenticate(authentication);
            //put the verifiedAuth by custom authentication provider into security context
            SecurityContextHolder.getContext().setAuthentication(verifiedAuth);
        }
        filterChain.doFilter(request, response);
    }
}

```

## 4. Custom web security config

```java
@Configuration
@EnableWebSecurity
public class WebSecurityConfig {
    @Autowired
    private CustomAuthenticationProvider customAuthenticationProvider;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests((requests) -> requests
                        .requestMatchers("/public/*").permitAll()
                        .anyRequest().authenticated()
                ).addFilterBefore(new CustomWebFilter(authManager()), LogoutFilter.class);
        return http.build();
    }
    //This is important to create a AuthenticationManager to apply custom authentication provider
    @Bean
    public AuthenticationManager authManager() {
        return new ProviderManager(customAuthenticationProvider);
    }
}
```

## 5. verify

```
# Access a public api
curl -i http://localhost:8080/public/stocks
HTTP/1.1 200

# Use a not admin user will hit 403 permission error
curl -i --header "Authentication: dXNlcjp1c2Vy" http://localhost:8080/private/stocks
HTTP/1.1 403

# Use an admin user will pass the authentication
$ curl -i --header "Authentication: YWRtaW46YWRtaW4=" http://localhost:8080/private/stocks
HTTP/1.1 200


```
