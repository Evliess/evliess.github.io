---
layout: index
title: "Ubuntu 22.04 Mysql8"
category: linux
date: 2025-08-21 15:17:55
---

## Install

```bash
sudo apt update
sudo apt upgrade

sudo apt install mysql-server
sudo systemctl status mysql
sudo mysql_secure_installation

# Please enter 0 = LOW, 1 = MEDIUM and 2 = STRONG: 1
# Remove anonymous users? (Press y|Y for Yes, any other key for No) : y
# Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y
# Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y
# Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y
```

### Security configuration

#### 配置防火墙
```bash
sudo ufw status numbered
sudo ufw delete 4
```

```bash
sudo ss -tlnp | grep mysql

#sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf #允许内网其他服务器访问

# disable LOCAL INFILE
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf

###
[mysqld]
# ... 其他配置 ...
local-infile = 0
[mysqld]

# ===== 基础设置 =====
# 只监听本地回环地址，增强安全性
bind-address = 127.0.0.1
# 禁用DNS反向解析，加速连接建立
skip_name_resolve = ON
# 默认字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# ===== 内存优化 (核心部分) =====
# InnoDB缓冲池 - 最关键参数，设置为总内存的10-15%
innodb_buffer_pool_size = 200M
# 使用1个缓冲池实例（小内存环境）
innodb_buffer_pool_instances = 1

# 每个连接的缓冲区大小（严格控制防止内存溢出）
sort_buffer_size = 256K
read_buffer_size = 128K
read_rnd_buffer_size = 256K
join_buffer_size = 128K
tmp_table_size = 16M
max_heap_table_size = 16M

# 连接限制
max_connections = 30
thread_cache_size = 10
# MySQL 8.0新增：限制单个连接的内存使用
connection_memory_limit = 10M
# 连接超时设置（快速释放空闲连接）
wait_timeout = 60
interactive_timeout = 60

# ===== InnoDB 优化 =====
# 事务日志设置（平衡性能与持久性）
innodb_log_file_size = 48M
innodb_log_buffer_size = 4M
# 事务提交方式：2=每秒刷盘（性能与安全平衡）
innodb_flush_log_at_trx_commit = 2
# 刷新邻接页（SSD可关闭）
innodb_flush_neighbors = 0
# 每表独立表空间
innodb_file_per_table = ON
# I/O容量设置（根据存储类型调整）
innodb_io_capacity = 200
innodb_io_capacity_max = 500

# ===== 功能禁用 (节省资源) =====
# 禁用性能模式（显著减少内存使用）
performance_schema = OFF

# ===== 其他优化 =====
# 表定义缓存
table_definition_cache = 400
table_open_cache = 1000
# 最大数据包大小
max_allowed_packet = 16M
# 临时目录（确保有足够空间）
tmpdir = /tmp
```
### 配置权限
```
sudo chown -R mysql:mysql /var/lib/mysql
sudo chmod -R 755 /var/lib/mysql
# 确保错误日志和慢查询日志目录存在且有正确权限
sudo mkdir -p /var/log/mysql
sudo chown -R mysql:adm /var/log/mysql
sudo chmod -R 755 /var/log/mysql
```

### 创建交换分区
```
sudo swapon --show

# 如果没有或需要增加，创建1GB交换文件
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效，添加到/etc/fstab
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 调整交换倾向(0-100，值越低越少使用交换)
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 重启使生效
```
sudo systemctl restart mysql
##检查启动错误
sudo tail -n 50 /var/log/mysql/error.log
```


### 使用
```bash
sudo mysql #go into command line
CREATE DATABASE <NAME>_db;
CREATE USER '<NAME>_user'@'<IP_ADDR>' IDENTIFIED BY '<PWD>';
GRANT CREATE, SELECT, INSERT, UPDATE, DELETE ON <NAME>_db.* TO '<NAME>_user'@'<IP_ADDR>';
FLUSH PRIVILEGES;
EXIT;
```

### BackUp

```bash
# mysql> SHOW VARIABLES LIKE 'datadir';
# +---------------+-----------------+
# | Variable_name | Value           |
# +---------------+-----------------+
# | datadir       | /var/lib/mysql/ |
# +---------------+-----------------+
# 1 row in set (0.04 sec)

# MySQL 版本完全一致：主版本、次版本甚至修订版本号都必须完全相同（例如，都是 8.0.36）。任何细微的版本差异都可能导致失败。

# 操作系统和架构相同：例如，都是从 Ubuntu 22.04 (x86_64) 复制到 Ubuntu 22.04 (x86_64)。

# 配置文件相似：特别是与 InnoDB 相关的核心配置，如 innodb_page_size、innodb_log_file_size 等必须完全一致。

# 权限必须正确：复制到新服务器后，所有文件和目录的属主和属组必须是 mysql

sudo systemctl stop mysql
sudo chown -R mysql:mysql /var/lib/mysql

## mysqldump 推荐

# 导出一个名为 myapp_db 的数据库
sudo mysqldump -u root -p myapp_db > myapp_db_backup.sql
# 导出所有数据库
sudo mysqldump -u root -p --all-databases > all_databases_backup.sql

scp myapp_db_backup.sql user@your_new_server_ip:/path/to/destination

# 登录 MySQL
sudo mysql -u root -p

# 在 MySQL 提示符下执行
CREATE DATABASE myapp_db;
EXIT;

sudo mysql -u root -p myapp_db < /path/to/destination/myapp_db_backup.sql
```

## Install docker on Ubuntu 22.04.5 LST

```
# 1. 卸载旧版本（如有）
sudo apt remove docker docker-engine docker.io containerd runc

# 2. 安装依赖
sudo apt update
sudo apt install -y ca-certificates curl gnupg lsb-release

# 3. 创建目录
sudo mkdir -p /etc/apt/keyrings

# 4. 下载阿里云提供的 GPG 密钥（替代官方）
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 5. 添加阿里云的 Docker APT 源
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 6. 安装 Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 7. 配置 /etc/docker/daemon.json

cat /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.1ms.run"
  ]
}

# 8. 重启Docker 服务

sudo systemctl daemon-reload
sudo systemctl restart docker
```

## Run a mysql 8.4 container

```bash
sudo docker pull mysql:8.4.7

sudo groupadd -g 3000 mysql
sudo useradd -u 3000 -g 3000 -M -s /bin/false mysql
sudo mkdir -p /data/mysql
sudo chown -R 3000:3000 /data/mysql
sudo chmod 700 /data/mysql

sudo docker run --name mysql -p 3306:3306 --user 3000:3000 -v /data/mysql:/var/lib/mysql -e MYSQL_USER=test_user -e MYSQL_ROOT_PASSWORD=qq123456 -d mysql:8.4.7 --mysql-native-password=ON

sudo docker exec -it mysql mysql -u root -p

select user, host, plugin from mysql.user;

alter user 'test_user'@'%' IDENTIFIED WITH mysql_native_password BY 'qq123456';
```

## Ubuntu 22.04 安装mysql 8.4.7

- https://dev.mysql.com/downloads/mysql/
- https://dev.mysql.com/downloads/repo/apt/
```
wget https://dev.mysql.com/get/mysql-apt-config_0.8.36-1_all.deb
sudo dpkg -i mysql-apt-config_0.8.36-1_all.deb

sudo apt update
sudo apt install mysql-server

#运行安全初始化（设置 root 密码等）
#sudo mysql_secure_installation
mysql --version
sudo mysql

#添加用户

-- 创建用户（% 表示任意主机）
CREATE USER 'test_user'@'%' IDENTIFIED BY 'qq123456';

-- 授权（这里以 mydb.* 为例，按需调整）
GRANT ALL PRIVILEGES ON mydb.* TO 'test_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;

# 查看 MySQL 配置,找到数据目录
sudo mysqld --verbose --help | grep "datadir"  
=> /var/lib/mysql/

# Removing MySQL with APT
sudo systemctl stop mysql
sudo apt-get remove mysql-server
sudo apt-get autoremove
```

## Uninstall

```bash
sudo systemctl stop mysql

sudo apt-get purge mysql-server mysql-client mysql-common mysql-server-core-* mysql-client-core-*

sudo apt-get autoremove
sudo apt-get autoclean

# 删除配置文件目录
sudo rm -rf /etc/mysql/

# 删除数据目录 (你的数据库文件就在这里)
sudo rm -rf /var/lib/mysql/

# 删除日志目录
sudo rm -rf /var/log/mysql

sudo deluser mysql
sudo delgroup mysql

sudo apt-get purge mysql-apt-config
mysql --version
```