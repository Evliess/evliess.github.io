---
layout: index
title: "Ubuntu 22.04 Mysql8"
category: linux
date: 2025-08-21 15:17:55
---

### Install

```bash
sudo apt update
sudo apt upgrade

sudo apt install mysql-server
sudo systemctl status mysql
sudo mysql_secure_installation

# Please enter 0 = LOW, 1 = MEDIUM and 2 = STRONG: 1
# Remove anonymous users? (Press y|Y for Yes, any other key for No) : y
# Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y
# Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y
# Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y
```

### Security configuration

#### 配置防火墙
```bash
sudo ufw status numbered
sudo ufw delete 4
```

```bash
sudo ss -tlnp | grep mysql

#sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf #允许内网其他服务器访问

# disable LOCAL INFILE
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf

###
[mysqld]
# ... 其他配置 ...
local-infile = 0
[mysqld]

# ===== 基础设置 =====
# 只监听本地回环地址，增强安全性
bind-address = 127.0.0.1
# 禁用DNS反向解析，加速连接建立
skip_name_resolve = ON
# 默认字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# ===== 内存优化 (核心部分) =====
# InnoDB缓冲池 - 最关键参数，设置为总内存的10-15%
innodb_buffer_pool_size = 200M
# 使用1个缓冲池实例（小内存环境）
innodb_buffer_pool_instances = 1

# 每个连接的缓冲区大小（严格控制防止内存溢出）
sort_buffer_size = 256K
read_buffer_size = 128K
read_rnd_buffer_size = 256K
join_buffer_size = 128K
tmp_table_size = 16M
max_heap_table_size = 16M

# 连接限制
max_connections = 30
thread_cache_size = 10
# MySQL 8.0新增：限制单个连接的内存使用
connection_memory_limit = 10M
# 连接超时设置（快速释放空闲连接）
wait_timeout = 60
interactive_timeout = 60

# ===== InnoDB 优化 =====
# 事务日志设置（平衡性能与持久性）
innodb_log_file_size = 48M
innodb_log_buffer_size = 4M
# 事务提交方式：2=每秒刷盘（性能与安全平衡）
innodb_flush_log_at_trx_commit = 2
# 刷新邻接页（SSD可关闭）
innodb_flush_neighbors = 0
# 每表独立表空间
innodb_file_per_table = ON
# I/O容量设置（根据存储类型调整）
innodb_io_capacity = 200
innodb_io_capacity_max = 500

# ===== 功能禁用 (节省资源) =====
# 禁用性能模式（显著减少内存使用）
performance_schema = OFF

# ===== 其他优化 =====
# 表定义缓存
table_definition_cache = 400
table_open_cache = 1000
# 最大数据包大小
max_allowed_packet = 16M
# 临时目录（确保有足够空间）
tmpdir = /tmp
```
### 配置权限
```
sudo chown -R mysql:mysql /var/lib/mysql
sudo chmod -R 755 /var/lib/mysql
# 确保错误日志和慢查询日志目录存在且有正确权限
sudo mkdir -p /var/log/mysql
sudo chown -R mysql:adm /var/log/mysql
sudo chmod -R 755 /var/log/mysql
```

### 创建交换分区
```
sudo swapon --show

# 如果没有或需要增加，创建1GB交换文件
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效，添加到/etc/fstab
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 调整交换倾向(0-100，值越低越少使用交换)
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 重启使生效
```
sudo systemctl restart mysql
##检查启动错误
sudo tail -n 50 /var/log/mysql/error.log
```


### 使用
```bash
sudo mysql #go into command line
CREATE DATABASE <NAME>_db;
CREATE USER '<NAME>_user'@'<IP_ADDR>' IDENTIFIED BY '<PWD';
GRANT CREATE, SELECT, INSERT, UPDATE, DELETE ON <NAME>_db.* TO '<NAME>_user'@'<IP_ADDR>';
FLUSH PRIVILEGES;
EXIT;
```



### BackUp

```bash
# mysql> SHOW VARIABLES LIKE 'datadir';
# +---------------+-----------------+
# | Variable_name | Value           |
# +---------------+-----------------+
# | datadir       | /var/lib/mysql/ |
# +---------------+-----------------+
# 1 row in set (0.04 sec)

# MySQL 版本完全一致：主版本、次版本甚至修订版本号都必须完全相同（例如，都是 8.0.36）。任何细微的版本差异都可能导致失败。

# 操作系统和架构相同：例如，都是从 Ubuntu 22.04 (x86_64) 复制到 Ubuntu 22.04 (x86_64)。

# 配置文件相似：特别是与 InnoDB 相关的核心配置，如 innodb_page_size、innodb_log_file_size 等必须完全一致。

# 权限必须正确：复制到新服务器后，所有文件和目录的属主和属组必须是 mysql

sudo systemctl stop mysql
sudo chown -R mysql:mysql /var/lib/mysql

## mysqldump 推荐

# 导出一个名为 myapp_db 的数据库
sudo mysqldump -u root -p myapp_db > myapp_db_backup.sql
# 导出所有数据库
sudo mysqldump -u root -p --all-databases > all_databases_backup.sql

scp myapp_db_backup.sql user@your_new_server_ip:/path/to/destination

# 登录 MySQL
sudo mysql -u root -p

# 在 MySQL 提示符下执行
CREATE DATABASE myapp_db;
EXIT;

sudo mysql -u root -p myapp_db < /path/to/destination/myapp_db_backup.sql
```